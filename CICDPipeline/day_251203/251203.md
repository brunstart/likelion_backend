# CI/CD 파이프라인
## CI (Continuous Integration - 지속적 통합)
- 개발자들이 작성한 코드를 자주 통합하는 프로세스
- 코드 변경 시 자동으로 빌드 및 테스트 실행
- 통합 과정에서 발생하는 문제를 조기에 발견

## CD (Continuous Deployment - 지속적 배포)
- 빌드 및 테스트를 통과한 코드를 자동으로 프로덕션 환경에 배포
- 배포 프로세스 자동화로 수동 작업 최소화
- 빠른 피드백 루프와 신속한 기능 출시

## CI/CD의 이점
개발 효율성:
- 반복적인 빌드/배포 작업 자동화
- 수동 오류 감소
- 개발자가 코드 작성에 집중 가능

품질 향상:
- 자동화된 테스트로 버그 조기 발견
- 일관된 빌드 및 배포 프로세스
- 코드 품질 표준화

### 일반적인 CI/CD 파이프라인
```
코드 작성 → Git Push → 자동 빌드 → 자동 테스트 → 배포 → 모니터링
    ↓                      ↓             ↓           ↓        ↓
  개발자              CI 서버        테스트 통과    EC2 서버   로그/알림
```

## Docker-compose.yml 작성
```
services:
  jenkins:
    image: jenkins/jenkins:latest-jdk21
    container_name: jenkins-server
    ports:
      - "9999:8080"
      - "50000:50000"
    environment:
      - TZ=Asia/Seoul
    volumes:
      - ./jenkins_home:/var/jenkins_home
      - /etc/localtime:/etc/localtime:ro
    restart: unless-stopped
```
![img_2.png](img_2.png)
- 설치 후 docker-compose up -d로 이미지 생성
- localhost:9999로 접속하면 initialPassword 입력하라고 나옴
- docker-compose logs jenkins로 로그에서 비밀번호를 찾을 수도 있고  
- jenkins-docker/jenkins_home/secrets 디렉토리 내 initialAdminPassword 파일에서도 확인 가능

## Jenkins 초기 환경 설정
![img_1.png](img_1.png)
- Install suggested plugins 선택
- 아이디 및 비밀번호 설정
![img_3.png](img_3.png)
- Jenkins URL 설정
![img_4.png](img_4.png)

## Jenkins Job 설정
1. 새 Job 생성
- 대시보드에서 New Item 클릭
![img_5.png](img_5.png)

2. General 설정
- Description: Spring Boot Todo App 자동 빌드 및 배포
- GitHub project (선택사항):
  - Project url: https://github.com/your-username/todoApp

3. Source Code Management 설정
- Git 선택
- Repository URL: https://github.com/your-username/todoApp.git
- Credentials:
  - GitHub Personal Access Token 사용 권장
  - Add → Jenkins 클릭
  - Kind: Username with password
  - Username: GitHub 사용자명
  - Password: GitHub Personal Access Token
- Branch: */main (또는 */master)
![img_6.png](img_6.png)
![img_7.png](img_7.png)

4. Build Triggers 설정:
- 옵션 1: Build periodically (주기적 빌드)
  - Schedule: H/15 * * * * (15분마다 빌드)
  - Cron 표현식 사용

- 옵션 2: GitHub hook trigger for GITScm polling
  - GitHub에서 Webhook 설정 필요
  - Push 이벤트 발생 시 자동 빌드
  - localhost 환경에서는 사용 불가 (외부 접근 필요)

- 옵션 3: Poll SCM (추천)
  - Schedule: H/5 * * * * (5분마다 저장소 확인)
  - 변경사항이 있을 때만 빌드 실행
  ```
  # Cron 표현식 예시
  H/5 * * * *     # 5분마다
  H/15 * * * *    # 15분마다
  H * * * *       # 매시간
  H H * * *       # 매일
  ```
![img_8.png](img_8.png)

5. Build Environment 설정:
- ☑ Delete workspace before build starts (선택사항)
  - 빌드 전 작업 공간 초기화
  - 깨끗한 환경에서 빌드 보장

6. Build Steps 설정:
- 방법 1: Invoke Gradle script
  - Invoke Gradle: ☑ Use Gradle Wrapper
  - Tasks: clean build
  - Switches: -x test (테스트 제외, 선택사항)
- 방법 2: Execute shell
```
./gradlew clean build -x test
```
![img_9.png](img_9.png)

<빌드 성공 시>
![img_10.png](img_10.png)


# SSH를 통한 EC2 배포 설정
1. Publish Over SSH 플러그인 설치:
- Jenkins 관리 → Plugins → Available plugins
![img_11.png](img_11.png)
- 검색: "Publish Over SSH"
- Install 클릭
![img_12.png](img_12.png)
- 설치 후 재시작 체크

2.  SSH 서버 설정:
   - Jenkins 관리 → System → Publish over SSH
- SSH Servers 추가:
  - Name: EC2-TodoApp-Server
  - Hostname: EC2 퍼블릭 IP 주소 (예: 3.34.122.240)
  - Username: ec2-user
  - Remote Directory: /home/ec2-user

- Key 설정:
  - Key 영역에 .pem 파일 내용 전체 붙여넣기
    - -----BEGIN OPENSSH PRIVATE KEY-----부터
    - -----END OPENSSH PRIVATE KEY-----까지

![img_13.png](img_13.png)
- Test Configuration 클릭 해서 success 나오면 성공

3. Job에 Post-build Actions 추가
   - Add post-build action → Send build artifacts over SSH

- Transfer Set 설정
  - 첫 번째 Transfer (start.sh 전송):
    - SSH Server: EC2-TodoApp-Server
    - Source files: start.sh
    - Remove prefix: (비워둠)
    - Remote directory: (비워둠, 기본값 사용)
    - Exec command: chmod 755 /home/ec2-user/start.sh


  - 두 번째 Transfer 추가 (Add Transfer):
  - JAR 파일 전송:
    - Source files: build/libs/todoApp-0.0.1-SNAPSHOT.jar
    - Remove prefix: build/libs/
    - Remote directory: (비워둠)
    - Exec command:
    ```
    /home/ec2-user/start.sh
    ```
    
- start.sh 스크립트 (프로젝트 루트에 생성)
```
#!/bin/bash

# 실행 중인 프로세스 종료
pkill -f todoApp-0.0.1-SNAPSHOT.jar || echo "No app running"

# 프로세스 종료 대기
sleep 15

# 새 JAR 파일 실행
nohup /usr/bin/java -jar /home/ec2-user/todoApp-0.0.1-SNAPSHOT.jar > /home/ec2-user/app.log 2>&1 &

echo "Application deployment completed"
```

## Jenkins 빌드 실행 및 확인

1. 수동 빌드 실행:
   - Job 페이지에서 "Build Now" 클릭

2. 빌드 진행 상황 확인:
   - Build History에서 빌드 번호 클릭 (예: #1)
   - Console Output 클릭하여 실시간 로그 확인
3. EC2 서버에서 확인
```
# SSH 접속
ssh -i ~/Downloads/todoapp-key.pem ec2-user@<EC2_PUBLIC_IP>

# 프로세스 확인
ps aux | grep todoApp

# 로그 확인
tail -f app.log
```
4. 브라우저 확인
```
http://<EC2_PUBLIC_IP>:8080
```

# GitHub Actions 기반 CI/CD
## GitHub Actions
- GitHub에서 제공하는 클라우드 기반 CI/CD 플랫폼
- 별도 서버 설치 불필요
- .github/workflows 디렉토리에 YAML 파일로 정의
- 이벤트 기반 실행 (push, PR, release 등)

### 주요 개념
- Workflow: 전체 자동화 프로세스
- Job: 독립된 실행 단위
- Step: Job 내부의 개별 작업
- Runner: 워크플로우를 실행하는 서버 (GitHub-hosted or Self-hosted)
- Action: 재사용 가능한 작업 단위

## Workflow 파일 작성
1. 디렉토리 구조 생성
```
mkdir -p .github/workflows
```

2. Workflow 파일 생성
```
touch .github/workflows/deploy.yml
```

3. 기본 Workflow 작성
```
name: CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v3

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Grant execute permission to gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew clean build -x test
```
![img_14.png](img_14.png)

## Workflow 구성 요소 설명
- name: Workflow 이름
```
name: CI/CD Pipeline
```
- on: 트리거 이벤트 설정
```
on:
  push:
    branches: [ "main" ]      # main 브랜치에 push 시
  pull_request:
    branches: [ "main" ]      # main 브랜치로 PR 생성 시
  workflow_dispatch:          # 수동 실행 버튼
```
- jobs: 실행할 작업 정의
```
jobs:
  build:                      # Job 이름
    runs-on: ubuntu-latest    # 실행 환경
```
steps: 순차적으로 실행되는 단계
```
steps:
  - name: Check out code              # 코드 체크아웃
    uses: actions/checkout@v3

  - name: Set up JDK 21                # Java 21 설치
    uses: actions/setup-java@v3
    with:
      distribution: 'temurin'
      java-version: '21'

  - name: Build with Gradle           # Gradle 빌드
    run: ./gradlew clean build -x test
```
- github에 푸시 후 Actions 탭을 확인하면 workflow가 알아서 빌드 되는걸 볼 수 있음  

![img_15.png](img_15.png)

1. GitHub Secrets 설정:
   - Repository → Settings → Secrets and variables → Actions
   - New repository secret 클릭

![img_16.png](img_16.png)
![img_17.png](img_17.png)

### 필요한 Secrets:
  - EC2_SSH_KEY: EC2 접속용 .pem 파일 내용 전체
  - EC2_HOST: EC2 퍼블릭 IP 주소 (예: 3.34.122.240)
  - EC2_USER: ec2-user (기본값)

![img_18.png](img_18.png)

2. 완전한 배포 workflow
```
name: Deploy to EC2

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v3

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Grant execute permission to gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew clean build -x test

      - name: Upload start.sh file to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          source: "start.sh"
          target: "/home/ec2-user/"
          debug: true

      - name: Upload JAR file to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          source: "build/libs/todoApp-0.0.1-SNAPSHOT.jar"
          target: "/home/ec2-user/"
          debug: true

      - name: SSH to EC2 and run commands
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            mv build/libs/todoApp-0.0.1-SNAPSHOT.jar .
            chmod 755 start.sh
            ./start.sh
```
- 이미지 이름 및 secrets 이름은 본인 설정에 맞게 변경할 것

### 사용된 Third-party Actions

- appleboy/scp-action: SCP 파일 전송

```
- uses: appleboy/scp-action@v0.1.7
  with:
  host: ${{ secrets.EC2_HOST }}           # EC2 IP
  username: ${{ secrets.EC2_USER }}       # SSH 사용자
  key: ${{ secrets.EC2_SSH_KEY }}         # SSH 키
  source: "파일경로"                        # 전송할 파일
  target: "/home/ec2-user/"               # 대상 경로
```

- appleboy/ssh-action: SSH 명령 실행

```
- uses: appleboy/ssh-action@v0.1.8
  with:
  host: ${{ secrets.EC2_HOST }}
  username: ${{ secrets.EC2_USER }}
  key: ${{ secrets.EC2_SSH_KEY }}
  script: |                               # 실행할 명령어들
  chmod 755 start.sh
  ./start.sh
```

## GitHub Actions 실행 및 확인
1. Workflow 파일 푸시:
```
git add .github/workflows/deploy.yml
git commit -m "Add GitHub Actions workflow"
git push origin main
```
2. GitHub에서 실행 확인:
   - Repository → Actions 탭 클릭
   - 최근 Workflow 실행 목록 확인
   - Workflow 이름 클릭하여 상세 로그 확인
- 여기서 EC2 인바운드 규칙을 22 포트가 내 IP로 설정되어 있으면 에러가 날 수 있음, 0.0.0.0/0 으로 설정 후 테스트 진행할 것
- 에러 발생 시 app.log 파일 확인

## Discord 알람 기능
- deploy.yml에 해당 코드 추가
- 배포 완료 시 discord로 알람을 받을 수 있음.
- 채팅 채널의 웹후크 필요!
```
      - name: Discord Notification
        uses: Ilshidur/action-discord@master
        if: always() # 성공/실패 여부와 상관없이 실행
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          DISCORD_USERNAME: "GitHub-Bot"
          DISCORD_AVATAR: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
        with:
          args: '배포가 종료되었습니다! 상태: ${{ job.status }}'
```