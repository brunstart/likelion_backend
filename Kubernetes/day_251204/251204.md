# Kubernetes 쿠버네티스 - cmd 실습 위주로 진행
- 컨테이너(도커 등)를 대규모로 배포하고 운영하는 오케스트레이션 플랫폼

## 서비스를 이용하면 pod를 삭제해도 다시 포트포워딩 할 필요없이 동일한 포트넘버를 계속 이용할 수 있다.

## Docker
- 컨테이너 실행/중지
- 이미지 빌드
- 단일 호스트

## k8s (컨테이너 오케스트레이션)
- 여러 호스트 관리
- 자동 복구
- 자동 스케일링 (알아서 서버의 개수를 늘리거나 줄이거나)
- 로드 밸런싱
- 무중단 배포

```
마스터 노드
  API server <-- kubectl 명령
      |
  Scheduler : 어느 노드에 pod를 배치할 것인지 결정
      |
Controller Manager : 항상 원하는 상태로 유지
      |
    etcd : 모든 데이터를 보관하고 있는곳
```

# Pod (파드)
- 컨테이너(들)가 실행되는 최소 배포 단위, 보통 한 Pod에 하나의 컨테이너
- 특별한 경우(초기화 컨테이너, 사이드카 등)에는 여러 컨테이너가 하나의 Pod 안에서 함께 동작
```
사이드카(Sidecar) 는 Kubernetes에서 Pod 내부의 주 컨테이너(Main Container)를 보조하는 역할을 하는 컨테이너를 의미
"사이드카 패턴(Sidecar Pattern)"이라는 이름은 오토바이 사이드카에서 유래.
```
- Pod은 일회성으로 취급 -> Pod이 문제가 생겨 종료되면 자동으로 다시 살려야 하는데, 이를 Pod 단독으로 관리하기에는 불편
- Deployment 같은 상위 오브젝트로 Pod을 관리하는 것이 일반적

## deployment를 이용해  pod 생성, 스케일림
```
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hello-deployment
spec:
  replicas: 1   # Pod 수
  selector:
    matchLabels:
      app: hello-nginx
  template:
    metadata:
      labels:
        app: hello-nginx    # Pod 명
    spec:
      containers:                   # Pod안에 들어갈 컨테이너들의 목록
      - name: nginx-container       # 컨테이너 이름
        image: nginx:alpine         # 사용할 이미지
        ports:
        - containerPort: 80         # 사용할 포트
```

## Pod 스케일 업/다운
스케일 업: replicas 수를 늘려서 Pod 개수를 늘리는 작업
```
kubectl scale deployment hello-deployment --replicas=3      # 파드를 3개로 늘림
```
```
kubectl scale deployment hello-deployment --replicas=1      # 다시 1개로 줄임
```

## 정리(삭제)
```
kubectl delete deployment hello-deployment
```

## 명령어 옵션
```
kubectl run -it --rm debug-pod --image=busybox --restart=Never -- nslookup google.com
```
- --rm : 파드 이용 후 자동 삭제
- --image=busybox : 테스트용으로 많이 쓰는 이미지 (리눅스, 가볍게 만들어놓음)
- --restartNever=Never : 삭제하면 재시작하지 않음

## 프로세스 종료와 파드 삭제
```
kubectl exec zombie-nginx-b6d778846-npmc6 -- nginx -s stop
```
- 프로세스 종료를 하면 잠시 뒤 다시 살아나고 kubectl get po를 하면 RESTARTS 수가 늘어나 있음
  
```
kubectl delete pod zombie-nginx-b6d778846-npmc6
```
- 파드 삭제를 하면 새로운 이름의 파드가 다시 생성됨

## 파드의 정보 살펴보기
- 간단한 정보 : get pod pod명
- 좀 더 상세한 정보 : describe pod pod명
- get -o yaml : get의 정보를 yaml 파일로 넘김 (전체적인 정보를 볼수있음)


# 서비스 
- 쿠버네티스에서 Pod(또는 여러 Pod)에게 네트워크 접근을 제공해주는 중요한 리소스
- Pod는 동적으로 생성, IP주소도 언제든지 바뀔 수 있음. Pod IP를 직접 사용해 접근하면 관리 어려움
- 서비스는 Pod에 고정된 접근 지점(가상IP, 포트)를 부여, 로드밸런싱까지 담당

## 서비스의 종류
### ClusterIP (기본값)
- 클러스터 내부에서만 접근 가능한 가상 IP를 할당
- 외부(인터넷)에서는 접근 불가
### NodePort
- 각 노드(Worker Node)의 특정 포트를 개방해 외부에서도 접근 가능하게 함
- 실습용 혹은 로컬 환경에서 가장 많이 사용하는 방식
### LoadBalancer
- 클라우드 환경에서 자동으로 로드밸런서(예: AWS ELB, GCP LB)를 생성
- 외부(인터넷) IP를 할당받아 외부 트래픽을 분산 처리

# ConfigMap
- yml로 만듦, my-config라는 이름의 ConfigMap에 WELCOME_MESSAGE와 APP_MODE 두개의 데이터를 넣음
```
apiVersion: v1
kind: ConfigMap
metadata:
  name: my-config
data:
  WELCOME_MESSAGE: "Hello from ConfigMap!"
  APP_MODE: "development"
```
## 주요 속성
- apiVersion: v1, kind: ConfigMap
- metadata.name: ConfigMap의 이름(my-config)
- data: Key-Value 쌍으로 구성. 여기서 WELCOME_MESSAGE와 APP_MODE가 설정 키

## ConfigMap 사용 방법 - 환경 변수로 주입
Pod 내부의 컨테이너에서 환경 변수로 ConfigMap 값을 사용
```
apiVersion: v1
kind: Pod
metadata:
  name: my-app
spec:
  containers:
  - name: app-container
    image: busybox
    command: [ "/bin/sh", "-c", "echo $WELCOME_MESSAGE && echo $APP_MODE && sleep 3600" ]
    env:
    - name: WELCOME_MESSAGE
      valueFrom:
        configMapKeyRef:
          name: my-config
          key: WELCOME_MESSAGE
    - name: APP_MODE
      valueFrom:
        configMapKeyRef:
          name: my-config
          key: APP_MODE
```
- env 섹션에서 configMapKeyRef를 사용하여 ConfigMap 값을 환경 변수로 주입
- valueFrom.configMapKeyRef.name: 사용할 ConfigMap의 이름 (my-config)
- key: ConfigMap에서 사용할 특정 키 (WELCOME_MESSAGE, APP_MODE)

# Secret
- 민감 정보(비밀번호, 토큰, API 키 등) 를 저장하기 위한 리소스
- 내부적으로 base64 인코딩되어 보관되지만, 실제로는 평문 보호 이상의 보안이 필요한 경우엔 추가 보호 수단(예: 암호화, Vault 사용)도 고려
- ConfigMap과 사용법이 비슷하지만, 예시로 DB_PASSWORD 같은 정보를 저장
```
apiVersion: v1
kind: Secret
metadata:
  name: my-secret
type: Opaque
data:
  DB_PASSWORD: "c2VjdXJldHBhc3N3b3Jk"  # base64 인코딩된 문자열
```
- yml 파일 예시

## Deployment에서 ConfigMap & Secret 사용
- Pod(Deployment) 에서 이 설정값들을 환경변수로 주입해 사용
- deploy-config-secret.yml 파일
```
apiVersion: apps/v1
kind: Deployment
metadata:
  name: config-secret-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: config-secret-demo
  template:
    metadata:
      labels:
        app: config-secret-demo
    spec:
      containers:
      - name: node-container
        image: busybox
        command: ["/bin/sh", "-c", "echo WELCOME=$WELCOME_MESSAGE APP=$APP_MODE PASS=$DB_PASSWORD && sleep 3600"]
        ports:
        - containerPort: 3000
        env:
        - name: WELCOME_MESSAGE
          valueFrom:
            configMapKeyRef:
              name: my-config       # ConfigMap 이름
              key: WELCOME_MESSAGE  # ConfigMap 내 키
        - name: APP_MODE
          valueFrom:
            configMapKeyRef:
              name: my-config
              key: APP_MODE
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: my-secret      # Secret 이름
              key: DB_PASSWORD     # Secret 내 키
```
### 주요 포인트
- env: 아래에 valueFrom.configMapKeyRef 와 valueFrom.secretKeyRef
- configMapKeyRef: ConfigMap에서 특정 key값을 가져옴
- secretKeyRef: Secret에서 특정 key값을 가져옴
- replicas: 1 로 Pod 1개만 구동